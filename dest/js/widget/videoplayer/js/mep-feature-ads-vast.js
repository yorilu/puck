(function(e){e.extend(mejs.MepDefaults,{vastAdTagUrl:""}),e.extend(MediaElementPlayer.prototype,{buildvast:function(e,t,n,r){var i=this;i.options.vastAdTagUrl!=""&&i.vastLoadAdTagInfo(),i.buildads(e,t,n,r),i.vastSetupEvents()},vastAdTagIsLoading:!1,vastAdTagIsLoaded:!1,vastStartedPlaying:!1,vastAdTags:[],vastSetupEvents:function(){var e=this;e.container.on("mejsprerollstarted",function(){console.log("VAST","mejsprerollstarted");if(e.vastAdTags.length>0){var n=e.vastAdTags[0];n.trackingEvents.start&&e.adsLoadUrl(n.trackingEvents.start);if(!n.shown&&n.impressions.length>0)for(var r=0,i=n.impressions.length;r<i;r++)e.adsLoadUrl(n.impressions[r]);n.shown=!0}}),e.container.on("mejsprerollended",function(){console.log("VAST","mejsprerollended"),e.vastAdTags.length>0&&e.vastAdTags[0].trackingEvents.complete&&e.adsLoadUrl(e.vastAdTags[0].trackingEvents.complete)})},vastSetAdTagUrl:function(e){var t=this;t.options.vastAdTagUrl=e,t.vastAdTagIsLoaded=!1,t.vastAdTags=[]},vastLoadAdTagInfo:function(){console.log("loading vast ad data");var e=this;e.adsDataIsLoading=!0,e.vastAdTagIsLoading=!0,e.loadAdTagInfoDirect()},loadAdTagInfoDirect:function(){console.log("loading vast:direct");var t=this;e.ajax({url:t.options.vastAdTagUrl,crossDomain:!0,success:function(e){console.log("vast:direct:success",e),t.vastParseVastData(e)},error:function(e){console.log("vast:direct:error",e),t.loadAdTagInfoProxy()}})},loadAdTagInfoProxy:function(){console.log("loading vast:proxy:yahoo");var t=this,n=location.protocol,r=location.hostname,i=RegExp(n+"//"+r),s='select * from xml where url="'+encodeURI(t.options.vastAdTagUrl)+'"',o="http"+(/^https/.test(n)?"s":"")+"://query.yahooapis.com/v1/public/yql?format=xml&q="+s;e.ajax({url:o,crossDomain:!0,success:function(e){console.log("vast:proxy:yahoo:success",e),t.vastParseVastData(e)},error:function(e){console.log("vast:proxy:yahoo:error",e)}})},vastParseVastData:function(t){var n=this;n.vastAdTags=[],e(t).find("Ad").each(function(t,r){var i=e(r),s={id:i.attr("id"),title:e.trim(i.find("AdTitle").text()),description:e.trim(i.find("Description").text()),impressions:[],clickThrough:e.trim(i.find("ClickThrough").text()),mediaFiles:[],trackingEvents:{},shown:!1};n.vastAdTags.push(s),i.find("Impression").each(function(){s.impressions.push(e.trim(e(this).text()))}),i.find("Tracking").each(function(t,n){var r=e(n);s.trackingEvents[r.attr("event")]=e.trim(r.text())}),i.find("MediaFile").each(function(t,r){var i=e(r),o=i.attr("type");n.media.canPlayType(o).toString().replace(/no/,"").replace(/false/,"")!=""&&s.mediaFiles.push({id:i.attr("id"),delivery:i.attr("delivery"),type:i.attr("type"),bitrate:i.attr("bitrate"),width:i.attr("width"),height:i.attr("height"),url:e.trim(i.text())})})}),n.vastLoaded()},vastLoaded:function(){var e=this;e.vastAdTagIsLoaded=!0,e.vastAdTagIsLoading=!1,e.adsDataIsLoading=!1,e.vastStartPreroll()},vastStartPreroll:function(){console.log("vastStartPreroll");var e=this;e.vastAdTags.length>0&&e.vastAdTags[0].mediaFiles.length>0&&(e.options.adsPrerollMediaUrl=e.vastAdTags[0].mediaFiles[0].url,e.options.adsPrerollAdUrl=e.vastAdTags[0].clickThrough,e.adsStartPreroll())}})})(mejs.$)