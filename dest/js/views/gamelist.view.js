define(["backbone","text!../templates/gamelist.tpl.html","puck","baseview","modelFactory","utils","scroller","videoPlayer"],function(e,t,n,r,i,s,o,u){var a=s.Date,f=i.get("gamesModel"),l=r.extend({events:{"click .J_game":"goNextPage"},dateTplFun:null,gameTplFun:null,getGamesParam:{clientId:"h5",pageSize:"4",upDown:"down",pageIndex:1},livingGameIds:[],liveingGameTimer:null,prePageIndex:1,nextPageIndex:1,player:null,scroll:null,onInit:function(){this.$el.html(t),this.todayStr=a.calDateByOffset(0)+" 00:00:00",this.getGamesParam.startDate=this.todayStr,this.els={dateContainer:this.$el.find("#J_index_game_wapper"),dateListTpl:this.$el.find("#index_games_date_list_tpl"),gameListTpl:this.$el.find("#index_games_game_list_tpl")},this.dateTplFun=_.template(this.els.dateListTpl.html()),this.gameTplFun=_.template(this.els.gameListTpl.html()),this.player=new MediaElementPlayer("#js_main_video",{features:["playpause","progress","current","fullscreen","titlebar"]});var e=this;this.showLoading(),this.getGamesReq(this.getGamesParam,function(t){var n=e.formattData(t.data);e.renderList(n)})},onShow:function(){var e=this;this.liveingGameTimer=setInterval(function(){e.refreshGameScore()},6e4),this.bindScroll()},onHide:function(){clearInterval(this.liveingGameTimer),this.scroll.destroy()},refreshGameScore:function(){if(this.livingGameIds.length>0){var e=_.clone(this.getGamesParam);e.pageIndex=1,e.status=1,this.getGamesReq(e,function(e){var t=e.data;_.each(t,function(e,t){var n=$("#"+e.id+"_"+e.homeTeamId+"_score"),r=$("#"+e.id+"_"+e.guestTeamId+"_score");n.html(e.teamAScore),r.html(e.teamBScore)})})}},getGamesReq:function(e,t){var n=this;f.$post({data:e,success:function(e){n.hideLoading(),e.length<20?n.scroll.destroy():n.scroll.on(),t.apply(n,[e])}})},renderList:function(e){this.renderDateList(e.dateMap),this.renderGameList(e.gameMap)},renderDateList:function(e,t){var n=this.dateTplFun({data:e}),r=this.els.dateContainer;r.children().length>0?t=="up"?r.prepend(n):r.append(n):r.html(n)},renderGameList:function(e,t){var n=this;_.each(e,function(e,r){var i=n.$el.find("#J_index_games_ui_"+r),s=n.gameTplFun({data:e});i.children().length>0?t=="up"?i.prepend(s):i.append(s):i.html(s)})},formattData:function(e){var t=this,n={},r={};return _.each(e,function(e,i){var o=e.startTime.substr(0,10);n[o]||(n[o]=[],r[o]=s.Trans.date(o)),e.status==1&&t.livingGameIds.push(e.id),n[o].push(e)}),{gameMap:n,dateMap:r}},goNextPage:function(e){var t=$(e.currentTarget),r=t.data("gameid"),i=t.data("status"),o=t.data("path"),u=t.data("title");i=="0"?n.go("/game/"+r):i=="1"?(o=s.Util.rtmp2m3u8(o),this.player.setSrc(o),this.player.setTitle(u),this.player.play(),this.player.enterFullScreen()):i=="2"&&n.go("/game/"+r)},getNextPageData:function(){var e=this;this.nextPageIndex++,this.getGamesParam.pageIndex=this.nextPageIndex,this.getGamesParam.upDown="down",this.getGamesReq(this.getGamesParam,function(t){var n=e.formattData(t.data),r={};_.each(n.dateMap,function(e,t){var n=$("#j_index_games_ui_"+t);n.length==0&&(r[t]=e)}),e.renderDateList(r),e.renderGameList(n.gameMap)})},getPrePageData:function(){var e=this;this.prePageIndex++,this.getGamesParam.pageIndex=this.prePageIndex,this.getGamesParam.upDown="up",this.getGamesReq(this.getGamesParam,function(t){var n=e.formattData(t.data),r={};_.each(n.dateMap,function(e,t){var n=$("#j_index_games_ui_"+t);n.length==0&&(r[t]=e)}),e.renderDateList(r,"up"),e.renderGameList(n.gameMap,"up")})},bindScroll:function(e){var t=this;this.scroll=new o(this.$el,{onScroll:function(e,n,r){n(),e==-1?t.getPrePageData():t.getNextPageData()}})}});return l})