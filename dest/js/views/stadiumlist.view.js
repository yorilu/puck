define(["backbone","text!../templates/stadiumlist.tpl.html","puck","baseview","modelFactory","utils","scroller","geolocation"],function(e,t,n,r,i,s,o,u){var a=i.get("getCityStadiumList"),f=i.get("getCityList"),l=function(e){this.self=e};l.prototype={cityId:2,sportType:"",pageSize:20,pageIndex:1,iscomplete:!1,scrollAdapter:function(e,t){var n=this.self;e&&(t?this.addListRender(e):this.listRender(e))},errorEvt:function(){var e=this.self;this.iscomplete=!0,e.hideLoading()},listRender:function(e){var t=this.self;window.scrollTo(0,0),t.hideLoading(),e&&e.data&&e.data.length>0?(t.els.stadiumContainer.html(t.stadiumTplFun({data:e.data})).show(),this.iscomplete=!1):(t.els.stadiumContainer.html(t.els.noStadiumTpl.html()),this.iscomplete=!0)},addListRender:function(e){var t=this.self;e&&e.data&&e.data.length>0?(t.els.stadiumContainer.append(t.stadiumTplFun({data:e.data})).show(),this.iscomplete=!1):this.iscomplete=!0}};var c=r.extend({events:{"click .js_type div":"selectType","click .js_stadiumlist_item":"goStadiumDetail","click .js_goCityList":"goCityList"},requestStadiumList:function(e,t){var n=this;e?this.listHelper.pageIndex+=1:(this.showLoading(),this.listHelper.pageIndex=1),console.log(this.listHelper.pageIndex),a.$post({data:{clientId:"h5",cityId:this.listHelper.cityId,showAll:s.Store.get("SMART_HIDE_MODE")?"Y":"N",sportType:this.listHelper.sportType,pageSize:this.listHelper.pageSize,pageIndex:this.listHelper.pageIndex},success:function(r){n.listHelper.scrollAdapter(r,e),console.log(r),t&&t()},error:function(){t&&t()}})},selectType:function(e){var t=$(e.currentTarget);if(t.hasClass("sta-seted"))return;t.siblings().removeClass("sta-seted"),t.addClass("sta-seted"),this.listHelper.sportType=t.attr("data-value"),this.requestStadiumList()},bingScroll:function(){var e=this;e.myScrollHandler=new o(this.$el,{onScroll:function(t,n,r){if(t==-1||e.listHelper.iscomplete)return;n(),e.requestStadiumList(!0,function(){r()})}})},goStadiumDetail:function(e){var t=$(e.currentTarget),r=t.data("stadiumid");n.go("stadium/"+r)},goCityList:function(e){n.go("citylist")},doGeoService:function(){var e=this;u.getCurrentPosition({onComplete:function(t){var n=t.result.addressComponent.city.replace("市","").replace("省","").replace("县","");console.log(t.result.addressComponent.city.replace("市","").replace("省","").replace("县","")),e.requestCityList(n)}})},requestCityList:function(e){var t=this,n={id:null,name:e};f.$post({success:function(r){if(r&&r.data&&r.data.length>0)for(var i=0,o=r.data.length;i<o;i++)if(r.data[i].name==e){n={id:r.data[i].id,name:r.data[i].name};break}s.Store.set("LOCATION_CITY",n),n&&n.id&&n.id!=t.listHelper.cityId&&confirm("系统定位您在"+n.name+"，是否切换？")&&(t.listHelper.cityId=n.id,t.$el.find(".js_goCityList").html(n.name),s.Store.set("SMART_SELECTED_CITY",n),t.requestStadiumList())},error:function(){}})},onInit:function(){this.notFirstEnter=!0,this.listHelper=new l(this),this.$el.html(t),this.els={stadiumContainer:this.$el.find("#js_stadiumContainer"),stadiumTpl:this.$el.find("#stadium_tpl"),noStadiumTpl:this.$el.find("#no_stadium_tpl")},this.stadiumTplFun=_.template(this.els.stadiumTpl.html())},onShow:function(e){if(!this.notFirstEnter&&(!e||e.data!="selected"))return;e&&e.data=="selected"&&(this.listHelper.sportType="",this.$el.find(".js_type div").removeClass("sta-seted"),$(this.$el.find(".js_type div")[0]).addClass("sta-seted")),s.Store.get("SMART_SELECTED_CITY")||s.Store.set("SMART_SELECTED_CITY",{id:2,name:"北京"});var t=s.Store.get("SMART_SELECTED_CITY");this.listHelper.cityId=t&&t.id?t.id:2,this.$el.find(".js_goCityList").html(t&&t.name?t.name:"北京"),this.notFirstEnter&&this.doGeoService(),this.notFirstEnter=!1,this.requestStadiumList(),this.bingScroll()},onHide:function(){this.myScrollHandler.destroy()}});return c})