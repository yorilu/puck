define(["backbone","text!../templates/gameevent.tpl.html","puck","baseview","modelFactory","utils","scroller"],function(e,t,n,r,i,s,o){var u=i.get("getGameEvent"),a=r.extend({events:{},reqParam:{pageIndex:1},periodTplFun:null,evtTplFun:null,endTplFun:null,gameData:{},firstShow:!0,onInit:function(){this.$el.html(t),this.els={wrapper:this.$el.find("#j_game_event_ul_wrapper"),periodTpl:this.$el.find("#j_game_event_period_tpl"),evtTpl:this.$el.find("#j_game_event_period_evts_tpl"),endTpl:this.$el.find("#j_game_event_period_end_tpl"),gameDesc:this.$el.find("#j_game_event_game_des")},this.periodTplFun=_.template(this.els.periodTpl.html()),this.evtTplFun=_.template(this.els.evtTpl.html()),this.endTplFun=_.template(this.els.endTpl.html())},onShow:function(e){var t=this;this.gameData=e.data,this.reqParam.gameId=e.data.id,this.firstShow&&(this.gameData.status=="0"?this.showNoData():this.sendReq(this.reqParam,function(e){if(e.length==0)t.showNoData();else{var n=t.getSection(e);t.renderPeriod(n)}}),this.els.gameDesc.html(this.gameData.startTime.substr(0,16)+" 比赛在 "+this.gameData.stadiumName+"举行")),this.bindScroll(),this.firstShow=!1},onHide:function(){this.myScrollHandler&&this.myScrollHandler.destroy()},bindScroll:function(){var e=this;e.myScrollHandler=new o(this.$el,{onScroll:function(t,n,r){if(t==-1)return;n(),e.reqParam.pageIndex++,e.sendReq(e.reqParam,function(t){e.appendNextPage(t),t.length<20?e.myScrollHandler.destroy():e.myScrollHandler.on()})}})},sendReq:function(e,t){var n=this;u.$post({data:e,success:function(e){t.apply(n,[e.data])}})},renderPeriod:function(e){var t=this,n=this.periodTplFun({data:e});this.els.wrapper.children().length>0?this.els.wrapper.append(n):this.els.wrapper.html(n),_.each(e,function(e,n){var r=$("#j_game_event_period_wapper_"+n),i=t.evtTplFun(e);r.html(i)})},appendNextPage:function(e){var t=this.getSection(e),n=this,r={};_.each(t,function(e,t){var i=$("#j_game_event_period_wapper_"+t);i.length>0?(e.events&&i.append(n.evtTplFun(e)),e.start&&(e.end=e.start,i.parent().after(n.endTplFun(e)))):r[t]=e}),this.renderPeriod(r)},getSection:function(e){var t=this,n={};return _.each(e,function(e,r){var i=n[e.competitionNode]||{};e.playerATeamId?(i.events||(i.events=[]),e.isHomeTeam=e.playerATeamId==t.gameData.homeTeamId,e.time=s.Date.ss2hhmmss(e.eventTime),i.events.push(e)):i.start?i.end=e:i.start=e,n[e.competitionNode]=i}),n},showNoData:function(){this.$el.find(".no-data").show()}});return a})